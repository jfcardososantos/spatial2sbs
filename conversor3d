#!/bin/zsh

# Script Conversor de V√≠deo Espacial para SBS
# Autor: ALF Studio Tech
# Data: 29/10/2025

clear
echo "======================================"
echo "   CONVERSOR 3D - SPATIAL VIDEO ‚Üí SBS"
echo "======================================"
echo ""

# Solicita o caminho do arquivo
echo "Arraste o arquivo de v√≠deo espacial para esta janela e pressione ENTER:"
read -r input_file

# Remove aspas e espa√ßos extras do caminho
input_file=$(echo "$input_file" | sed "s/^['\"]//;s/['\"]$//")

# Verifica se o arquivo existe
if [ ! -f "$input_file" ]; then
    echo "‚ùå Erro: Arquivo n√£o encontrado!"
    exit 1
fi

# Obt√©m o diret√≥rio e nome do arquivo sem extens√£o
dir=$(dirname "$input_file")
filename=$(basename "$input_file")
name="${filename%.*}"

echo ""
echo "üìÅ Arquivo de entrada: $filename"
echo "üìÇ Pasta de sa√≠da: $dir"
echo ""
echo "‚è≥ Iniciando convers√£o..."
echo ""

# Cria pasta tempor√°ria para arquivos intermedi√°rios
temp_dir="$dir/temp_conversion_$$"
mkdir -p "$temp_dir"

# Passo 1: Extrair view esquerda (olho esquerdo)
echo "üé¨ [1/3] Extraindo view esquerda..."
ffmpeg -i "$input_file" -an -map 0:v:view:0 -c:v libx264 "$temp_dir/view0.mp4" -y 2>&1 | grep -E "frame=|time=|size=" || true

# Passo 2: Extrair view direita (olho direito)
echo ""
echo "üé¨ [2/3] Extraindo view direita..."
ffmpeg -i "$input_file" -an -map 0:v:view:1 -c:v libx264 "$temp_dir/view1.mp4" -y 2>&1 | grep -E "frame=|time=|size=" || true

# Passo 3: Combinar em SBS e adicionar √°udio
echo ""
echo "üé¨ [3/3] Combinando em formato SBS e adicionando √°udio..."
output_file="$dir/${name}_SBS.mp4"
ffmpeg -i "$temp_dir/view0.mp4" -i "$temp_dir/view1.mp4" -i "$input_file" \
    -filter_complex "[0:v][1:v]hstack=inputs=2[v]" \
    -map "[v]" -map 2:a \
    -c:v libx264 -preset medium -crf 18 \
    -c:a aac -b:a 192k \
    "$output_file" -y 2>&1 | grep -E "frame=|time=|size=" || true

# Limpa arquivos tempor√°rios
echo ""
echo "üßπ Limpando arquivos tempor√°rios..."
rm -rf "$temp_dir"

# Verifica se a convers√£o foi bem-sucedida
if [ -f "$output_file" ]; then
    echo ""
    echo "======================================"
    echo "‚úÖ CONVERS√ÉO CONCLU√çDA COM SUCESSO!"
    echo "======================================"
    echo ""
    echo "üìπ Arquivo de sa√≠da: ${name}_SBS.mp4"
    echo "üìÇ Local: $dir"
    echo ""
    
    # Pergunta se deseja abrir a pasta
    echo "Deseja abrir a pasta do arquivo? (s/n)"
    read -r open_folder
    if [[ "$open_folder" =~ ^[Ss]$ ]]; then
        open "$dir"
    fi
else
    echo ""
    echo "‚ùå Erro durante a convers√£o!"
    echo "Verifique se o FFmpeg est√° instalado corretamente."
    exit 1
fi

echo ""
echo "Pressione ENTER para sair..."
read

